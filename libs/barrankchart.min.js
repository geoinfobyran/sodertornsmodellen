!function(t){function e(a){if(i[a])return i[a].exports;var r=i[a]={i:a,l:!1,exports:{}};return t[a].call(r.exports,r,r.exports,e),r.l=!0,r.exports}var i={};e.m=t,e.c=i,e.i=function(t){return t},e.d=function(t,i,a){e.o(t,i)||Object.defineProperty(t,i,{configurable:!1,enumerable:!0,get:a})},e.n=function(t){var i=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(i,"a",i),i},e.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},e.p="",e(e.s=6)}([function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),i(3);var a=i(1),r=function(t){return t&&t.__esModule?t:{default:t}}(a),n={version:"2.0.0",build:1516906861777};e.default=Vizabi.Tool.extend("BarRankChart",{init:function(t,e){this.name="barrankchart",this.components=[{component:r.default,placeholder:".vzb-tool-viz",model:["state.time","state.marker","locale","ui"]},{component:Vizabi.Component.get("timeslider"),placeholder:".vzb-tool-timeslider",model:["state.time","state.marker","ui"]},{component:Vizabi.Component.get("dialogs"),placeholder:".vzb-tool-dialogs",model:["state","ui","locale"]},{component:Vizabi.Component.get("buttonlist"),placeholder:".vzb-tool-buttonlist",model:["state","ui","locale"]},{component:Vizabi.Component.get("treemenu"),placeholder:".vzb-tool-treemenu",model:["state.marker","state.marker_tags","state.time","locale"]},{component:Vizabi.Component.get("datanotes"),placeholder:".vzb-tool-datanotes",model:["state.marker","locale"]},{component:Vizabi.Component.get("datawarning"),placeholder:".vzb-tool-datawarning",model:["locale"]},{component:Vizabi.Component.get("steppedspeedslider"),placeholder:".vzb-tool-stepped-speed-slider",model:["state.time","locale"]}],this._super(t,e)},default_model:{state:{time:{autoconfig:{type:"time"}},entities:{autoconfig:{type:"entity_domain",excludeIDs:["tag"]}},entities_colorlegend:{autoconfig:{type:"entity_domain",excludeIDs:["tag"]}},entities_tags:{autoconfig:{type:"entity_domain",includeOnlyIDs:["tag"]}},marker_tags:{space:["entities_tags"],label:{use:"property",which:"name"},hook_parent:{}},entities_allpossible:{autoconfig:{type:"entity_domain",excludeIDs:["tag"]}},marker_allpossible:{space:["entities_allpossible"],label:{use:"property",autoconfig:{includeOnlyIDs:["name"],type:"string"}}},marker:{space:["entities","time"],axis_x:{use:"indicator",autoconfig:{type:"measure"},allow:{scales:["linear","log"]}},label:{use:"property",autoconfig:{includeOnlyIDs:["name"],type:"string"}},color:{syncModels:["marker_colorlegend"],autoconfig:{}}},marker_colorlegend:{space:["entities_colorlegend"],label:{use:"property",which:"name"},hook_rank:{use:"property",which:"rank"},hook_geoshape:{use:"property",which:"shape_lores_svg"}}},locale:{},ui:{chart:{},datawarning:{doubtDomain:[],doubtRange:[]},buttons:["colors","find","show","moreoptions","fullscreen","presentation"],dialogs:{popup:["timedisplay","colors","find","show","moreoptions"],sidebar:["timedisplay","colors","find"],moreoptions:["opacity","speed","colors","presentation","about"]},presentation:!1}},versionInfo:n})},function(t,e,i){"use strict";function a(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function r(t){if(Array.isArray(t)){for(var e=0,i=Array(t.length);e<t.length;e++)i[e]=t[e];return i}return Array.from(t)}Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(t,e){var i=[],a=!0,r=!1,n=void 0;try{for(var o,s=t[Symbol.iterator]();!(a=(o=s.next()).done)&&(i.push(o.value),!e||i.length!==e);a=!0);}catch(t){r=!0,n=t}finally{try{!a&&s.return&&s.return()}finally{if(r)throw n}}return i}return function(e,i){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return t(e,i);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),o=i(2),s=function(t){return t&&t.__esModule?t:{default:t}}(o),l=Vizabi.utils,h=Vizabi.helpers["d3.axisWithLabelPicker"],c=Vizabi.iconset.question,d=Vizabi.iconset.warn,g=Vizabi.Component.extend("barrankchart",a({init:function(t,e){var a=this;this.name="barrankchart",this.template=i(4),this.model_expects=[{name:"time",type:"time"},{name:"marker",type:"marker"},{name:"locale",type:"locale"},{name:"ui",type:"ui"}],this.model_binds={"change:time.value":function(){a.model._ready&&a._readyOnce&&a.onTimeChange()},"change:marker.select":function(){a._readyOnce&&(a._selectBars(),a._updateOpacity(),a._updateDoubtOpacity(),a._scroll())},"change:marker.axis_x.scaleType":function(){a._readyOnce&&a.loadData()&&a.draw(!0)},"change:marker.color.palette":function(){a._drawColors()},"change:marker.highlight":function(){a._updateOpacity()},"change:marker.opacitySelectDim":function(){a._updateOpacity()},"change:marker.opacityRegular":function(){a._updateOpacity()}},this._super(t,e),this.xScale=null,this.cScale=d3.scaleOrdinal(d3.schemeCategory10),this.xAxis=h("bottom")},onTimeChange:function(){var t=this;this.model.marker.getFrame(this.model.time.value,function(e){t.values=e,t.values&&t.loadData()&&t.draw()})},readyOnce:function(){this.element=d3.select(this.element),this.header=this.element.select(".vzb-br-header"),this.infoEl=this.element.select(".vzb-br-axis-info"),this.barViewport=this.element.select(".vzb-br-barsviewport"),this.barSvg=this.element.select(".vzb-br-bars-svg"),this.barContainer=this.element.select(".vzb-br-bars"),this.dataWarningEl=this.element.select(".vzb-data-warning"),this.wScale=d3.scaleLinear().domain(this.model.ui.datawarning.doubtDomain).range(this.model.ui.datawarning.doubtRange),this.xAxis.tickFormat(this.model.marker.axis_x.getTickFormatter()),this._localeId=this.model.locale.id,this._entityLabels={},this._presentation=!this.model.ui.presentation,this._formatter=this.model.marker.axis_x.getTickFormatter(),this.ready(),this._selectBars()},ready:function(){var t=this;this.TIMEDIM=this.model.time.getDimension(),this.KEYS=l.unique(this.model.marker._getAllDimensions({exceptType:"time"})),this.KEY=this.KEYS.join(","),this.dataKeys=this.model.marker.getDataKeysPerHook(),this.labelNames=this.model.marker.getLabelHookNames(),this.model.marker.getFrame(this.model.time.value,function(e){t.values=e,t.values&&(t.markerKeys=t.model.marker.getKeys(),t.loadData()&&(t.draw(!0),t._updateOpacity(),t._drawColors()))})},resize:function(){this.draw(!0),this._drawColors()},loadData:function(){var t=this,e=this;this.translator=this.model.locale.getTFunction();var i=this.values.axis_x;if(!Object.keys(i).length)return!1;this.sortedEntities=this._sortByIndicator(i,this.dataKeys.axis_x),this.header.select(".vzb-br-title").select("text").on("click",function(){return t.parent.findChildByName("gapminder-treemenu").markerID("axis_x").alignX("left").alignY("top").updateView().toggle()}),this.xScale=this.model.marker.axis_x.getScale().copy(),this.cScale=this.model.marker.color.getScale(),l.setIcon(this.dataWarningEl,d).select("svg").attr("width",0).attr("height",0),this.dataWarningEl.append("text").text(this.translator("hints/dataWarning")),this.dataWarningEl.on("click",function(){return t.parent.findChildByName("gapminder-datawarning").toggle()}).on("mouseover",function(){return t._updateDoubtOpacity(1)}).on("mouseout",function(){return t._updateDoubtOpacity()});var a=this.model.marker.axis_x.getConceptprops();return l.setIcon(this.infoEl,c).select("svg").attr("width",0).attr("height",0).style("opacity",Number(Boolean(a.description||a.sourceLink))),this.infoEl.on("click",function(){t.parent.findChildByName("gapminder-datanotes").pin()}),this.infoEl.on("mouseover",function(){var t=this.getBBox(),i=l.makeAbsoluteContext(this,this.farthestViewportElement),a=i(t.x-10,t.y+t.height+10);e.parent.findChildByName("gapminder-datanotes").setHook("axis_x").show().setPos(a.x,a.y)}),this.infoEl.on("mouseout",function(){e.parent.findChildByName("gapminder-datanotes").hide()}),!0},draw:function(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.time_1=null==this.time?this.model.time.value:this.time,this.time=this.model.time.value;var e=this.model.time.playing&&this.time-this.time_1>0?this.model.time.delayAnimations:0;this.drawAxes(e,t)||this.drawData(e,t)},drawAxes:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e={small:{margin:{top:60,right:5,left:5,bottom:20},headerMargin:{top:10,right:20,bottom:20,left:20},infoElHeight:16,infoElMargin:5,barHeight:18,barMargin:3,barRectMargin:5,barValueMargin:5,scrollMargin:20},medium:{margin:{top:60,right:5,left:5,bottom:20},headerMargin:{top:10,right:20,bottom:20,left:20},infoElHeight:16,infoElMargin:5,barHeight:21,barMargin:3,barRectMargin:5,barValueMargin:5,scrollMargin:25},large:{margin:{top:60,right:5,left:5,bottom:20},headerMargin:{top:10,right:20,bottom:20,left:20},infoElHeight:16,infoElMargin:5,barHeight:28,barMargin:4,barRectMargin:5,barValueMargin:5,scrollMargin:25}},i={medium:{margin:{top:60,right:10,left:10,bottom:40},headerMargin:{top:10,right:20,bottom:20,left:20},infoElHeight:25,infoElMargin:10,barHeight:25,barMargin:6},large:{margin:{top:60,right:10,left:10,bottom:40},headerMargin:{top:10,right:20,bottom:20,left:20},infoElHeight:16,infoElMargin:10,barHeight:30,barMargin:6}};this.activeProfile=this.getActiveProfile(e,i);var a=this.activeProfile,r=a.margin,n=a.headerMargin,o=a.infoElHeight,s=a.infoElMargin;if(this.height=parseInt(this.element.style("height"),10)||0,this.width=parseInt(this.element.style("width"),10)||0,!this.height||!this.width)return l.warn("Dialog resize() abort: vizabi container is too little or has display:none");this.barViewport.style("height",this.height-r.bottom-r.top+"px"),this.header.attr("height",r.top);var h=this.header.select(".vzb-br-title"),c=this.model.marker.axis_x.getConceptprops(),d=c.name,g=c.unit,u=h.select("text");if(g){u.text(d+", "+g);n.left+h.node().getBBox().width+s+o>this.width-n.right&&u.text(d)}else u.text(d);var m=h.node().getBBox(),b=n.left,p=n.top+m.height;h.attr("transform","translate("+b+", "+p+")");var f=this.infoEl;f.select("svg").attr("width",o+"px").attr("height",o+"px");var v=b+h.node().getBBox().width+s,y=n.top+o/4;f.attr("transform","translate("+v+", "+y+")");var x=this.header.select(".vzb-br-total");t?x.select("text").transition("text").delay(t).text(this.model.time.formatDate(this.time)):x.select("text").interrupt().text(this.model.time.formatDate(this.time)),x.style("opacity",Number("large"!==this.getLayoutProfile()));var _=x.node().getBBox(),w=this.width-n.right-_.width,k=n.top+_.height;x.attr("transform","translate("+w+", "+k+")").classed("vzb-transparent",m.width+_.width+10>this.width),this.element.select(".vzb-data-warning-svg").style("height",r.bottom+"px");var z=this.dataWarningEl.select("text").node().getBBox();this.dataWarningEl.attr("transform","translate("+(this.width-r.right-z.width)+", "+z.height+")").select("text"),this.dataWarningEl.select("svg").attr("width",z.height).attr("height",z.height).attr("x",-z.height-5).attr("y",1-z.height),this._updateDoubtOpacity()},drawData:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]&&arguments[1],a=this.KEY;this._createAndDeleteBars(this.barContainer.selectAll(".vzb-br-bar").data(this.sortedEntities,function(t){return t[a]}));var n=this.model.ui.presentation,o=this._presentation!==n;o&&(this._presentation=n);var s="undefined"===typeof this._entitiesCount||this._entitiesCount!==this.sortedEntities.length;(o||s)&&s&&(this._entitiesCount=this.sortedEntities.length),this._resizeSvg(),this._scroll(e),this._drawColors();var l=this.activeProfile,h=l.barRectMargin,c=l.barValueMargin,d=l.scrollMargin,g=l.margin,u=this.model.marker.axis_x,m=u.getLimits(u.which),b=Math.abs(m.max)>=Math.abs(m.min),p=b?m.min<0:m.max>0,f=(this.width-g.right-g.left-h-d-(p?0:this._getWidestLabelWidth()))/(p?2:1);this.xScale.range([0,f]),"log"!==this.model.marker.axis_x.scaleType&&this.xScale.domain([0,Math.max.apply(Math,r(this.xScale.domain()))]);var v=p?f:this._getWidestLabelWidth(),y=function(e){return t.xScale(e)},x=function(t){return b?t>=0:t>0},_=function(t){return x(t)?"end":"start"},w=function(t){return x(t)?"start":"end"},k=function(e){return x(e)?g.left+v:t.width-v-d-g.right},z=function(t){return x(t)?k(t)+h:k(t)-h},C=function(t){return x(t)?z(t)+c:z(t)-c},S=this._getWidestLabelWidth(!0)+(b?g.left:g.right)<v;this.sortedEntities.forEach(function(a){var r=a.value;if((i||o||a.isNew||a.changedValue)&&(a.barLabel.attr("x",k(r)).attr("y",t.activeProfile.barHeight/2).attr("text-anchor",_(r)).text(S?a.label:a.labelSmall),a.barRect.attr("rx",t.activeProfile.barHeight/4).attr("ry",t.activeProfile.barHeight/4).attr("height",t.activeProfile.barHeight),a.barValue.attr("x",C(r)).attr("y",t.activeProfile.barHeight/2).attr("text-anchor",w(r))),i||a.changedWidth||o){var n=Math.max(0,r&&y(Math.abs(r)))||0;(i||a.changedWidth||o)&&a.barRect.transition().duration(e).ease(d3.easeLinear).attr("width",n),a.barRect.attr("x",z(r)-(r<0?n:0)),(i||a.changedValue)&&a.barValue.text(t._formatter(r)||t.translator("hints/nodata"))}(i||a.changedIndex||o)&&(!e&&a.self.interrupt(),(e?a.self.transition().duration(e).ease(d3.easeLinear):a.self).attr("transform","translate(0, "+t._getBarPosition(a.index)+")"))})},_resizeSvg:function(){var t=this.activeProfile,e=t.barHeight,i=t.barMargin;this.barSvg.attr("height",(e+i)*this.sortedEntities.length+"px")},_scroll:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=this.barContainer.select(".vzb-selected");if(!e.empty()){var i=e.datum(),a=this._getBarPosition(i.index),r=this.activeProfile.margin,n=this.height-r.top-r.bottom,o=a-(n+this.activeProfile.barHeight)/2;this.barViewport.transition().duration(t).tween("scrollfor"+i.entity,this._scrollTopTween(o))}},_getLabelText:function(t,e,i){return this.KEYS.map(function(a){return t[e[a]]?t[e[a]][i[a]]:i[a]}).join(", ")},_createAndDeleteBars:function(t){var e=this,i=this.KEYS,a=(this.dataKeys,n(this.sortedEntities,1)),r=a[0];this._entityLabels[r.entity]||(this._entityLabels[r.entity]=r.label);var o=this._getLabelText(this.values,this.labelNames,r.entity),s=this._entityLabels[r.entity]!==o&&this.model.locale.id!==this._localeId;s&&(this._localeId=this.model.locale.id,this._entityLabels[r.entity]=o),t.exit().remove(),t=(s?t:t.enter().append("g")).each(function(t){var a=d3.select(this),r=t.label,n=r.length<12?r:r.substring(0,9)+"...",o=a.select(".vzb-br-label"),h=o.size()?o:a.append("text").attr("class","vzb-br-label").attr("dy",".325em"),c=h.text(r).node().getBBox().width,d=h.text(n).node().getBBox().width;if(Object.assign(t,{labelWidth:c,labelSmallWidth:d,labelSmall:n,barLabel:h}),!s){a.attr("class","vzb-br-bar").classed("vzb-selected",e.model.marker.isSelected(t.entity)).attr("id","vzb-br-bar-"+l.getKey(t.entity,i)+"-"+e._id).on("mousemove",function(t){return e.model.marker.highlightMarker(t.entity)}).on("mouseout",function(){return e.model.marker.clearHighlighted()}).on("click",function(t){e.model.marker.selectMarker(t.entity)});var g=a.append("rect").attr("stroke","transparent"),u=a.append("text").attr("class","vzb-br-value").attr("dy",".325em");Object.assign(t,{self:a,isNew:!0,barRect:g,barValue:u})}}).merge(t)},_getWidestLabelWidth:function(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],e=t?"labelWidth":"labelSmallWidth",i=t?"label":"labelSmall",a=this.sortedEntities.reduce(function(t,i){return t[e]<i[e]?i:t}),r=a.barLabel.text(),n=a.barLabel.text(a[i]).node().getBBox().width;return a.barLabel.text(r),n},_drawColors:function(){var t=this,e=this,i=this.dataKeys;this.barContainer.selectAll(".vzb-br-bar>rect").each(function(t){var a=t.entity,r=d3.select(this),n=e.values.color[l.getKey(a,i.color)],o=n||0===n,s=o?String(e._getColor(n)):"rgb(253, 253, 253)",h=o?"transparent":"rgb(51, 51, 51)";r.style("fill")!==s&&r.style("fill",s),r.style("stroke")!==h&&r.style("stroke",h)}),this.barContainer.selectAll(".vzb-br-bar>text").style("fill",function(e){var a=e.entity;return t._getDarkerColor(t.values.color[l.getKey(a,i.color)]||null)})},_getColor:function(t){return d3.rgb(this.cScale(t))},_getDarkerColor:function(t){return this._getColor(t).darker(2)},_scrollTopTween:function(t){return function(){var e=this,i=d3.interpolateNumber(this.scrollTop,t);return function(t){e.scrollTop=i(t)}}},_getBarPosition:function(t){return(this.activeProfile.barHeight+this.activeProfile.barMargin)*t},_entities:{},_sortByIndicator:function(t,e){var i=this,r=this.KEYS;this.KEY,this.dataKeys;return this.markerKeys.map(function(n){var o,s=l.getKey(n,r),h=i._entities[s],c=t[l.getKey(n,e)],d=i._getLabelText(i.values,i.labelNames,n),g=i._formatter(c);return h?Object.assign(h,{value:c,label:d,formattedValue:g,changedValue:g!==h.formattedValue,changedWidth:c!==h.value,isNew:!1}):i._entities[s]=(o={entity:n,value:c,label:d,formattedValue:g},a(o,i.KEY,s),a(o,"changedValue",!0),a(o,"changedWidth",!0),a(o,"isNew",!0),o)}).sort(function(t,e){var i=t.value;return e.value-i}).map(function(t,e){return Object.assign(t,{index:e,changedIndex:e!==t.index})})},_selectBars:function(){var t=this,e=this.KEYS,i=this.model.marker.select;this.barContainer.classed("vzb-dimmed-selected",!1),this.barContainer.selectAll(".vzb-br-bar.vzb-selected").classed("vzb-selected",!1),i.length&&(this.barContainer.classed("vzb-dimmed-selected",!0),i.forEach(function(i){t.barContainer.select("#vzb-br-bar-"+(0,s.default)(l.getKey(i,e))+"-"+t._id).classed("vzb-selected",!0)}))},_updateOpacity:function(){var t=this.model.marker,e=t.highlight,i=t.select,a=t.opacityHighlightDim,r=t.opacitySelectDim,n=t.opacityRegular,o=e.length>0,s=i.length>0;this.barContainer.selectAll(".vzb-br-bar").style("opacity",function(e){return o&&t.isHighlighted(e.entity)?1:s?t.isSelected(e.entity)?n:r:o?a:n})},_updateDoubtOpacity:function(t){this.dataWarningEl.style("opacity",t||(this.model.marker.select.length?1:this.wScale(+this.model.time.value.getUTCFullYear().toString())))}},"_getLabelText",function(t,e,i){return this.KEYS.map(function(a){return t[e[a]]?t[e[a]][i[a]]:i[a]}).join(", ")}));e.default=g},function(t,e,i){(function(e){!function(e,i){t.exports=i(e)}("undefined"!=typeof e?e:this,function(t){if(t.CSS&&t.CSS.escape)return t.CSS.escape;var e=function(t){if(0==arguments.length)throw new TypeError("`CSS.escape` requires an argument.");for(var e,i=String(t),a=i.length,r=-1,n="",o=i.charCodeAt(0);++r<a;)e=i.charCodeAt(r),n+=0!=e?e>=1&&e<=31||127==e||0==r&&e>=48&&e<=57||1==r&&e>=48&&e<=57&&45==o?"\\"+e.toString(16)+" ":(0!=r||1!=a||45!=e)&&(e>=128||45==e||95==e||e>=48&&e<=57||e>=65&&e<=90||e>=97&&e<=122)?i.charAt(r):"\\"+i.charAt(r):"�";return n};return t.CSS||(t.CSS={}),t.CSS.escape=e,e})}).call(e,i(5))},function(t,e){},function(t,e){t.exports='\x3c!-- Bar Chart Component --\x3e\n<div class="vzb-barrankchart">\n  <svg class="vzb-br-header">\n    <g class="vzb-br-title">\n      <text></text>\n    </g>\n    <g class="vzb-br-total">\n      <text></text>\n    </g>\n    <g class="vzb-br-axis-info vzb-noexport"></g>\n  </svg>\n\n  <div class="vzb-br-barsviewport vzb-dialog-scrollable">\n    <svg class="vzb-br-bars-svg">\n      <g class="vzb-br-bars"></g>\n    </svg>\n  </div>\n\n  <svg class="vzb-data-warning-svg">\n    <g class="vzb-data-warning vzb-noexport">\n      <svg></svg>\n      <text></text>\n    </g>\n  </svg>\n</div>\n'},function(t,e){var i;i=function(){return this}();try{i=i||Function("return this")()||(0,eval)("this")}catch(t){"object"===typeof window&&(i=window)}t.exports=i},function(t,e,i){t.exports=i(0)}]);
//# sourceMappingURL=barrankchart.min.js.map